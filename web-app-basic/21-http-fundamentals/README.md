# Chapter 21: HTTP の真実と API ライフサイクル

API 開発者として、HTTP はあなたの「言語」です。フレームワークを使う前に、その裏側で何が起きているかを深く理解しましょう。

## 1. HTTP リクエストの解剖

クライアントから送られてくるリクエストは、大きく3つのパーツで構成されます。

1. **Start Line**: メソッド (`GET`, `POST` 等) とパス (`/users`)、プロトコルバージョン。
2. **Headers**: メタデータ（認証情報、形式指定など）。
3. **Body**: 実際のデータ（JSON など）。

### メソッドの使い分け（セマンティクス）
- **GET**: 取得。副作用（データの書き換え）を持たせてはいけません。
- **POST**: 作成。何かが新しく生まれる時に使います。
- **PUT**: 置換。リソース全体を新しいデータで上書きします。
- **PATCH**: 部分更新。一部の項目だけを変更します。
- **DELETE**: 削除。

> [!IMPORTANT]
> **Idempotency (冪等性)**: 
> 「同じ操作を何回繰り返しても、結果が同じであるか」という性質です。
> GET, PUT, DELETE は冪等であるべきですが、POST は通常、実行するたびに新しいデータが作られるため冪等ではありません。

## 2. ステータスコードの意図

単に 200 や 500 を返すだけでなく、意味のあるコードを返すのが「プロ」です。

- **201 Created**: POST で無事に作成されたとき。
- **204 No Content**: 成功したが、返すデータがないとき（DELETE 等）。
- **401 Unauthorized**: 「誰か分からないからアクセスできないよ」（ログインして）。
- **403 Forbidden**: 「誰かは分かったけど、あなたにはこの権限がないよ」（管理者じゃない）。
- **404 Not Found**: リソースが存在しない。
- **422 Unprocessable Entity**: バリデーションエラーなどで処理できない。
- **500 Internal Server Error**: プログラムのバグ。

## 3. リクエストのライフサイクル

Hono 等のフレームワークにおいて、リクエストは以下の旅をします。
1. **Request Receive**: ネットワーク越しにデータが届く
2. **Middleware (Entry)**: ログ出力、CORS、共通処理
3. **Routing**: どの関数で処理するか決定
4. **Validation**: Zod 等でデータをチェック
5. **Logic**: ビジネスルールの実行（ここが最も重要！）
6. **Response Generation**: 結果を JSON 等に変換して送り返す

## 演習：HTTP クライアントを触ってみる

1. `curl` または VS Code の `REST Client` ( `.http` ファイル) を使って、適当な API にリクエストを送ってみましょう。
2. `index.ts` を実行して、それぞれのメソッドがどのようなレスポンスを返すか確認してください。

```bash
npx tsx index.ts
```
